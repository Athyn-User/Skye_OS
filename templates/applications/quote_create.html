{% extends 'base.html' %}

{% block title %}New Quote for {{ application.application_number }} - Skye OS{% endblock %}

{% block content %}
<h1>Create Quote for Application {{ application.application_number }}</h1>

<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <strong>Application Details:</strong> 
            {{ application.company.company_name }} - {{ application.product.product_name }}
            {% if application.broker %}
                (via {{ application.broker.broker_name }})
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="effective_date" class="form-label">Effective Date *</label>
                        <input type="date" name="effective_date" id="effective_date" class="form-control" 
                               value="{{ application.target_effective_date|date:'Y-m-d' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="expiration_date" class="form-label">Expiration Date *</label>
                        <input type="date" name="expiration_date" id="expiration_date" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="total_premium" class="form-label">Total Premium *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" name="total_premium" id="total_premium" class="form-control" 
                                   step="0.01" value="{{ application.estimated_premium }}" required>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="commission_amount" class="form-label">Commission Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" name="commission_amount" id="commission_amount" class="form-control" step="0.01">
                        </div>
                        <div class="form-text">Leave blank if not applicable</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="special_conditions" class="form-label">Special Conditions</label>
                        <textarea name="special_conditions" id="special_conditions" class="form-control" rows="4" 
                                  placeholder="Any special terms, conditions, or notes for this quote..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <strong>Note:</strong> This quote will automatically update the application status to "Quoted" and set the quoted premium.
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{% url 'applications:application_detail' application.pk %}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Create Quote</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calculate expiration date (1 year from effective date)
    const effectiveDate = document.getElementById('effective_date');
    const expirationDate = document.getElementById('expiration_date');
    
    function updateExpirationDate() {
        if (effectiveDate.value) {
            const effective = new Date(effectiveDate.value);
            const expiration = new Date(effective);
            expiration.setFullYear(expiration.getFullYear() + 1);
            expirationDate.value = expiration.toISOString().split('T')[0];
        }
    }
    
    effectiveDate.addEventListener('change', updateExpirationDate);
    
    // Set initial expiration date if effective date is already set
    updateExpirationDate();
    
    // Auto-calculate commission (10% of premium)
    const premiumInput = document.getElementById('total_premium');
    const commissionInput = document.getElementById('commission_amount');
    
    premiumInput.addEventListener('input', function() {
        if (this.value) {
            const premium = parseFloat(this.value);
            const commission = premium * 0.10;
            commissionInput.value = commission.toFixed(2);
        }
    });
});
</script>
{% endblock %}
